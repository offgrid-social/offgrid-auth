name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/offgrid_auth_test
      TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/offgrid_auth_test
      LOG_LEVEL: info
      REQUEST_BODY_LIMIT: 1mb
      CORS_ORIGINS: http://localhost:3000
      RATE_LIMIT_MAX: 100
      RATE_LIMIT_TIME_WINDOW: 1 minute
      ACCESS_TOKEN_EXPIRES_IN: 15m
      REFRESH_TOKEN_EXPIRES_IN: 30d
      JWT_ISSUER: ci
      JWT_AUDIENCE: ci
      JWT_PRIVATE_KEY: |
        -----BEGIN PRIVATE KEY-----
        MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDradaRhkgI2TUj
        P/mxFAbaL0picWgLjnKOmmgoWSSlY0yGKpPyUrrx2aDAYZUcz/WIgffwjZcLMfdb
        /wO82a7RmVFEMAMyyi0plOl7e15pwHKmlN0w2tb8IAtptP/7h6ZY8/TnPG9mMHrZ
        dQi8F0VYEbONlHMB39vhWBWi3rDTPros4pYlm4v7F9KA1mYHL6wnmdyGWtRCD6Ft
        q9ujYAdh4Qgp3islZ59S3mA9gUm2Mzn103eEyOrfXwvvrxX+jpdF4T6NQuFBrPaI
        edhH/PM3D755tp1XIjXzTJIgNnBzmj0HIRfxPmbZ2ahUg2xx4BaNoAe2VkMqw8dF
        iwW2kiBlAgMBAAECggEAF7uYzRz7gCDdsYsOkiKRukdQOXJzac7Xj7bTT1YFUsMb
        AN+kAKcEf8NP6HUuAjSY7UUlCNRNaOyFonmoF87eR/Ur8zLf76vgN7PygedjEkg7
        hr21OuqlB8/3NpXvxJzdUVRu2S0HkgbLK8cXtVanQASw1FIl8gdudF5b+Ap5SyJz
        ROUaATgm0ywak4Ksj9qZhWb61RwG7DWik9OKZhs/un51Y1NqUls57h2N4JG9lmna
        Oc3NLltChkLd6CXEJUooy61bx0/WyfJYCyO32PEtgujEuY5MM5JorRWnEiF4+QAG
        DTWJbrj0Q7i4PCReCPQEHv4UEOLHL3iLELFpp6KWQQKBgQD19IM8DVPaTAq/LKHC
        dDxlwrHLERGc38gbyOmjLSXxmVCxIBwFHx+MEFEvYF2kk/6ZaSmWWULpLqyI1DzE
        Y7bVSMfiS+gmQqnRjSI9YbzN+gYIGLPfk7Uivbpx/W4q8xWd2lqKX6UA5ECFL4k4
        acqJEfa9jJYfURwi6AunYpDSdQKBgQD1BxxmwKriVlLeQsKG4YXDFMwpUpzyZ8xu
        iFpK/xgcTYkZUqYSHhbu5vlfRxZ3DsbBV7IYLy/0YUBRoIQDwqmlUoedth0Av6f5
        Qbcxoze4R3MyAeLwhtdZDPORUtiUcxyfl5Pi1yJ8IpV1QRWNNtl+BdMYX/adgWZy
        /h+IwQd4MQKBgQCIBVWenHBHRc6bs38yHz5XuLjC6QmojEoKs64iRBG772Ik0vEs
        E+5Kc6uyW8TuA7rF9Na/A1ZxxxI8CcQhiFPQ2JNSn1Af+LYZ4ceR0r+r2h4D1EWF
        3BZMxEicSd/neM/3oI56ADMsrw7PmV52CGuuKnUeluVfJGg/Fb18MJKPEQKBgQDH
        Q+YsBgmykcNIr4AlUuiGMrap8F5koFdXmJndncDM251gM5+M4l2CIeKxQk2ZuzGV
        8KyMEGvuUNyOxXw21qtCIHDbqEvD3RlMks3Zl0PsIGclRvV46B/fcrHuADLT3x1r
        CEkjVBPeYf2r4qcVNYMAgtoeW4RiqOZZJCMfAuQBMQKBgFe44B66v2/zFYQLPl4T
        BpsnYTuQyfOcZV035VC9XH9jyYoNs3X6+0yuwgQO4ai5uD1Q+VIOIvcJ89YWhZQS
        TbHUk9UBFc7epvrUAw2tpD2BzwAhAj65j0S8x+2kfGzNEGLyIHASONZB5idO8E5a
        zh3huiIqEzZDSN0wW/epQGK6
        -----END PRIVATE KEY-----
      JWT_PUBLIC_KEY: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA62nWkYZICNk1Iz/5sRQG
        2i9KYnFoC45yjppoKFkkpWNMhiqT8lK68dmgwGGVHM/1iIH38I2XCzH3W/8DvNmu
        0ZlRRDADMsotKZTpe3teacByppTdMNrW/CALabT/+4emWPP05zxvZjB62XUIvBdF
        WBGzjZRzAd/b4VgVot6w0z66LOKWJZuL+xfSgNZmBy+sJ5nchlrUQg+hbavbo2AH
        YeEIKd4rJWefUt5gPYFJtjM59dN3hMjq318L768V/o6XReE+jULhQaz2iHnYR/zz
        Nw++ebadVyI180ySIDZwc5o9ByEX8T5m2dmoVINsceAWjaAHtlZDKsPHRYsFtpIg
        ZQIDAQAB
        -----END PUBLIC KEY-----
      BCRYPT_SALT_ROUNDS: 6

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: offgrid_auth_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 5s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Generate Prisma client
        run: npx prisma generate
      - name: Run migrations
        run: npx prisma migrate deploy
      - name: Lint
        run: npm run lint
      - name: Typecheck
        run: npm run typecheck
      - name: Test
        run: npm test
      - name: Build
        run: npm run build
